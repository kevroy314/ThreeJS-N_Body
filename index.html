<!DOCTYPE html>
<html>
	<head>
		<title>Three.js N-Body Simulation</title>
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				margin: 0px;
				overflow: hidden;
			}
		</style>
	</head>
	<body>
		<div id="container"></div>
		<script type="text/javascript" src="js/three.min.js"></script>
		<script type="text/javascript" src="js/stats.min.js"></script>
		<script type="text/javascript" src="js/OrbitControls.js"></script>
		<script type="text/javascript" src="js/nbody.js"></script>
		<script type="text/javascript">
			var container;
			var camera,scene,renderer,group,controls;
			var bodies = new Array();
			var bodyField;
			var sun,earth;
			var skyBoxSize = 10000;
			var sphereComplexity = 20;
			var numUpdatesPerFrame = 4;
			var updateDt = 1;
			var axisLength = 250;
			var FoV = 100;
			var nearFieldDistance = 1;
			
			init();
			animate();
			
			function init(){
				//Create Camera
				camera = new THREE.PerspectiveCamera(FoV,window.innerWidth/window.innerHeight,nearFieldDistance,skyBoxSize*Math.sqrt(3));
				camera.position.z = 500;
				
				//Create Camera Controls
				controls = new THREE.OrbitControls(camera);
				controls.maxDistance = skyBoxSize*0.5; //MAGIC# to prevent skybox clipping
				
				//Create Scene
				scene = new THREE.Scene();
				
				//Create/Add Body Group (lots of MAGIC#s)
				group = new THREE.Object3D();
				
				sun = newSphereMesh(50,'img/sun.jpg');
				group.add(sun);
				bodies.push(new GBody(new Vector3(0,0,0),new Vector3(0,0,0),1000000000000));
				
				earth = newSphereMesh(10,'img/earth.jpg');
				earth.position.x+=100;
				group.add(earth);
				bodies.push(new GBody(new Vector3(100,0,0),new Vector3(0.4,0.8,0.4),100));
				
				mars = newSphereMesh(10,'img/mars.jpg');
				mars.position.x+=-100;
				group.add(mars);
				bodies.push(new GBody(new Vector3(-100,0,0),new Vector3(0.4,0.8,0.4),100));
				
				bodyField = new GBodyField(bodies);
				
				scene.add(group);
				
				//Add Ambient Light Source
				var light = new THREE.AmbientLight(0xffffff);
				scene.add(light);
				
				//Add Axis Lines
				var xLine = newLineObject(-axisLength,0,0,axisLength,0,0,0xff0000);
				scene.add(xLine);
				
				var yLine = newLineObject(0,-axisLength,0,0,axisLength,0,0x00ff00);
				scene.add(yLine);
				
				var zLine = newLineObject(0,0,-axisLength,0,0,axisLength,0x0000ff);
				scene.add(zLine);
				
				//Add Skybox
				var skyGeometry = new THREE.CubeGeometry(skyBoxSize,skyBoxSize,skyBoxSize);
				var materialArray = [];
				var skyBoxImg = THREE.ImageUtils.loadTexture('img/stars.jpg'); //MAGIC#
				for (var i = 0; i < 6; i++) materialArray.push(new THREE.MeshBasicMaterial({map:skyBoxImg ,side: THREE.BackSide}));
				var skyMaterial = new THREE.MeshFaceMaterial(materialArray);
				var skyBox = new THREE.Mesh(skyGeometry,skyMaterial);
				scene.add(skyBox);
				
				//Add Frame Rate Statistics
				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				
				//Create Renderer
				renderer = new THREE.WebGLRenderer();
				renderer.setSize(window.innerWidth,window.innerHeight);
				
				//Embed Renderer and Frame Rate Statistics Into Page
				container = document.getElementById('container');
				container.appendChild(renderer.domElement);
				container.appendChild(stats.domElement);
				
				//Add Resize Event Listener
				window.addEventListener('resize',onWindowResize,false);
			}
			
			//Window Resize Event Handler
			function onWindowResize(){
				//Fix Camera Aspect Ratio
				camera.aspect = window.innerWidth/window.innerHeight;
				camera.updateProjectionMatrix();
				//Set Renderer Size
				renderer.setSize(window.innerWidth,window.innerHeight);
			}
			
			//Helper Function to Create a New Line Object
			function newLineObject(x0,y0,z0,x1,y1,z1,color){
				var lineGeometry = new THREE.Geometry();
				var vertArray = lineGeometry.vertices;
				vertArray.push(new THREE.Vector3(x0,y0,z0),new THREE.Vector3(x1,y1,z1));
				lineGeometry.computeLineDistances();
				var lineMaterial = new THREE.LineBasicMaterial({color:color});
				var line = new THREE.Line(lineGeometry,lineMaterial);
				return line;
			}
			
			//Helper Function to Create a New Sphere Object
			function newSphereMesh(r,texturePath){
				var texture = THREE.ImageUtils.loadTexture(texturePath);
				var geometry = new THREE.SphereGeometry(r,sphereComplexity,sphereComplexity);
				var material = new THREE.MeshLambertMaterial({map:texture,overdraw:true});
				var mesh = new THREE.Mesh(geometry,material);
				return mesh;
			}
			
			//Animate Function (loops)
			function animate(){
				for(var i = 0; i < numUpdatesPerFrame;i++)
					bodyField.update(updateDt);
				for(var i = 0; i < group.children.length;i++)
					group.children[i].position = new THREE.Vector3(bodyField.bodies[i].pos.x,bodyField.bodies[i].pos.y,bodyField.bodies[i].pos.z);
				
				renderer.render(scene, camera);
				stats.update();
				
				requestAnimationFrame(animate);
				
				controls.update();
			}
		</script>
	</body>
</html>